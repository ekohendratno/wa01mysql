<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="text-success"><i class="fa fa-comment me-2"></i>Manajemen Pesan</h4>
</div>

<!-- Statistik Pesan -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <h5>Total Pesan Dikirim</h5>
            <h2 class="text-success"><%= messages.counts.sent || 0 %>/<%= messages.messages.length || 0 %></h2>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <h5>Pesan Tertunda</h5>
            <h2 class="text-secondary"><%= messages.counts.pending || 0 %></h2>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <h5>Pesan Diproses</h5>
            <h2 class="text-warning"><%= messages.counts.processing || 0 %></h2>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <h5>Pesan Gagal</h5>
            <h2 class="text-danger"><%= messages.counts.failed || 0 %></h2>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="stat-card">
            <h5 class="mb-4"><i class="fa fa-envelope me-2"></i>Daftar Pesan</h5>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="filterPesan('all')">Semua</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="filterPesan('pending')">Pending</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="filterPesan('processing')">Processing</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="filterPesan('sent')">Sent</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="filterPesan('failed')">Failed</a>
                </li>
            </ul>
            <div class="row mb-3">
                <div class="col-md-12">
                    <input type="text" id="searchInput" class="form-control"
                        placeholder="Cari Role, Nomor Tujuan, Isi Pesan, Tipe, atau Status..." onkeyup="filterPesan()">
                </div>
            </div>
            <!-- Tabel Pesan -->
            <table class="table table-striped table-hover" id="pesanTable">
                <thead>
                    <tr>
                        <th>Role</th>
                        <th>Nomor Tujuan</th>
                        <th>Isi Pesan</th>
                        <th>Tipe</th>
                        <th>Status</th>
                        <th style="width: 100px;">Aksi</th>
                    </tr>
                </thead>
                <tbody>

                    <% if (!messages.messages || messages.messages.length === 0) { %>
                        <tr>
                            <td colspan="6" class="text-center">Tidak ada message terdaftar</td>
                        </tr>
                        <% } else { %>
                            <% messages.messages.forEach(message => { %>

                                <% const statusClass={ 'processing' : 'warning' ,'sent' : 'success' , 'failed'
                                    : 'danger' , 'pending' : 'secondary' }[message.status] || 'default' %>

                                    <tr data-status="<%= message.status %>">
                                        <td>
                                            <%= message.role %>
                                        </td>
                                        <td>
                                            <%= message.number %>
                                        </td>
                                        <td>
                                            <%= message.message %>
                                        </td>
                                        <td>
                                            <%= message.type %>
                                        </td>
                                        <td><span class="badge bg-<%= statusClass %>">
                                                <%= message.status %>
                                            </span></td>
                                        <td>
                                            <button class="btn btn-sm btn-warning btn-action"
                                                onclick="confirmDeleteRetry('<%= message.id %>')">
                                                <i class="fa fa-repeat"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger btn-action"
                                                onclick="confirmDelete('<%= message.id %>')">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>

                                    <% }) %>
                                        <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- <div class="col-md-4">
        <div class="stat-card">
            <h5 class="mb-4"><i class="fa fa-history me-2"></i>Riwayat Pesan</h5>
            <ul class="list-group">
                <li class="list-group-item">Pesan ke +6281234567890 terkirim - 5 menit lalu</li>
                <li class="list-group-item">Pesan ke +6289876543210 pending - 10 menit lalu</li>
                <li class="list-group-item">Pesan ke +6281122334455 gagal - 15 menit lalu</li>
            </ul>
        </div>
    </div> -->
</div>


<!-- Floating Button -->
<button class="floating-button" data-bs-toggle="modal" data-bs-target="#formKirimPesan">+</button>

<!-- Form Dialog Kirim Pesan -->
<div id="formKirimPesan" class="modal" style="display: none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="sendMessageForm">
                <div class="modal-header">
                    <h5 class="modal-title">Kirim Pesan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Perangkat</label>
                        <select id="device" class="form-control">
                            <% devices.forEach(device=> { %>
                                <option value="<%= device.device_key %>">
                                    <%= device.name %> (<%= device.phone %>)
                                </option>
                                <% }) %>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipe Pesan:</label>
                        <select id="group" class="form-control" required>
                            <option value="false">Pribadi</option>
                            <option value="true">Grup</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Role:</label>
                        <select id="role" class="form-control" required>
                            <option value="group">Group</option>
                            <option value="guru">Guru</option>
                            <option value="siswa">Siswa</option>
                            <option value="wali">Wali</option>
                            <option value="ortu">Ortu</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tujuan:</label>
                        <input type="text" id="to" class="form-control"
                            placeholder="Nomor telepon atau ID grup (pisahkan dengan koma)" required>
                    </div>
                    <div class="form-group">
                        <label>Isi Pesan:</label>
                        <textarea id="text" class="form-control" rows="4" placeholder="Tulis pesan Anda..."
                            required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-secondary" data-bs-dismiss="modal">Batalkan</a>
                    <button id="sendMessageButton" class="btn btn-success" type="submit">Kirim</button>
                </div>
            </form>
        </div>
    </div>
</div>

<input type="hidden" id="apiKey" value="<%= apiKey %>">

<script>

    function filterPesan(status = 'all') {
        const searchKeyword = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#pesanTable tbody tr');

        rows.forEach(row => {
            const role = row.cells[0].innerText.toLowerCase();
            const number = row.cells[1].innerText.toLowerCase();
            const message = row.cells[2].innerText.toLowerCase();
            const type = row.cells[3].innerText.toLowerCase();
            const rowStatus = row.getAttribute('data-status');
            const statusText = row.cells[4].querySelector('.badge').innerText.toLowerCase();

            const statusMatch = status === 'all' || rowStatus === status;

            const keywordMatch =
                role.includes(searchKeyword) ||
                number.includes(searchKeyword) ||
                message.includes(searchKeyword) ||
                type.includes(searchKeyword) ||
                statusText.includes(searchKeyword);

            if (statusMatch && keywordMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        const tabs = document.querySelectorAll('.nav-tabs .nav-link');
        tabs.forEach(tab => tab.classList.remove('active'));
        if (status !== 'all') {
            event.target.classList.add('active');
        }
    }

    $("#sendMessageForm").submit(async function (event) {
        event.preventDefault();

        const apiKey = $("#apiKey").val();
        const deviceKey = $("#device").val();
        const role = $("#role").val().trim();
        const to = $("#to").val().trim();
        const text = $("#text").val().trim();
        const group = $("#group").val() === "true";
        const sendMessageButton = document.getElementById('sendMessageButton');

        
        if (!deviceKey || !to || !text) {
            alert("Semua field harus diisi!");
            return;
        }
        // Disable tombol dan ubah teks jadi "Memproses..."
        sendMessageButton.disabled = true;
        sendMessageButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Memproses...';

        $.ajax({
            url: "/bot/message",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                apiKey: apiKey,
                deviceKey: deviceKey,
                role: role,
                to: to,
                text: text,
                isGroup: group
            }),
            success: function(response) {
                alert(response.message);
                console.log("Pesan berhasil dikirim:", response);
            },
            error: function(xhr, status, error) {            
                alert("Terjadi kesalahan saat mengirim pesan.");
                console.error("Gagal mengirim pesan:", xhr.responseText || error);
            },
            complete: function () {
                sendMessageButton.disabled = false;
                sendMessageButton.innerHTML = 'Kirim';
                location.reload();

            }
        });
    });

    async function confirmDelete(id) {
        if (!confirm(`Apakah Anda yakin ingin menghapus pesan ${id}?`)) return;

        const apiKey = document.getElementById('apiKey').value;

        try {
            const response = await fetch(`/admin/message/remove?apiKey=${encodeURIComponent(apiKey)}&id=${encodeURIComponent(id)}`, {
                method: 'DELETE',
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const result = await response.json();

            if (result.status) {
                alert('Perangkat berhasil dihapus!');
                window.location.reload();
            } else {
                throw new Error(result.message || 'Gagal menghapus perangkat');
            }
        } catch (error) {
            console.error('Error:', error);
            alert(`Error: ${error.message}`);
        }
    }
</script>